<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
/* Mobile-First Design - Optimized for 375px-430px */
:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --danger-color: #dc3545;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --touch-target: 44px;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 16px;
    overflow-x: hidden;
    padding-bottom: env(safe-area-inset-bottom);
}

/* Screen Management */
.screen {
    min-height: 100vh;
}

#homeScreen {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

#workoutScreen {
    background-color: #f5f5f5;
}

#historyScreen {
    background-color: #f5f5f5;
}

/* Sticky Header */
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    padding: 12px 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-back {
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: 24px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
}

.btn-back:active {
    background: var(--light-bg);
}

/* Workout Content */
.workout-content {
    padding: 12px 12px 80px 12px;
}

/* History Content */
.history-content {
    padding: 12px 12px 80px 12px;
}

.history-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.history-card:active {
    transform: scale(0.98);
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.history-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.history-date {
    font-size: 17px;
    font-weight: 700;
    color: #333;
}

.history-duration {
    font-size: 14px;
    color: var(--primary-color);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
}

.history-stats {
    font-size: 14px;
    color: #6c757d;
    margin-bottom: 6px;
    font-weight: 500;
}

.history-exercises {
    font-size: 13px;
    color: #495057;
    margin-bottom: 8px;
}

.history-time {
    font-size: 12px;
    color: #adb5bd;
}

.timer {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-color);
    font-family: 'Courier New', monospace;
}

/* Exercise Card */
.exercise-card {
    background: white;
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}

.exercise-header {
    padding: 12px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
}

.exercise-header:active {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a3f90 100%);
}

.exercise-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.exercise-header h6 {
    margin: 0;
    font-size: 17px;
    font-weight: 600;
}

.chevron {
    font-size: 18px;
    transition: transform 0.3s ease;
    display: inline-block;
}

.chevron.collapsed {
    transform: rotate(-90deg);
}

.delete-exercise-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: var(--touch-target);
    height: var(--touch-target);
    border-radius: 8px;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    pointer-events: all;
    z-index: 10;
}

.delete-exercise-btn:active {
    background: rgba(255,255,255,0.3);
}

.exercise-body {
    padding: 12px;
    max-height: 5000px;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
}

.exercise-body.collapsed {
    max-height: 0;
    padding: 0 12px;
}

/* Horizontal Sets Overview */
.sets-overview-container {
    margin-bottom: 12px;
    background: white;
    border-radius: 8px;
    padding: 8px 0;
}

.sets-overview {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 0 12px;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.sets-overview::-webkit-scrollbar {
    display: none;
}

.set-card {
    flex-shrink: 0;
    width: 90px;
    background: var(--light-bg);
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 10px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    scroll-snap-align: start;
}

.set-card.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.set-card-number {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 6px;
    opacity: 0.8;
}

.set-card.selected .set-card-number {
    opacity: 1;
}

.set-card-value {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
}

.set-card-actual {
    font-size: 11px;
    opacity: 0.7;
    color: var(--success-color);
}

.set-card.selected .set-card-actual {
    color: #fff;
    opacity: 0.9;
}

.set-card-pending {
    font-size: 11px;
    opacity: 0.4;
}

/* Current Set Details */
.current-set-details {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
}

.current-set-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--light-bg);
}

.current-set-title {
    font-weight: 600;
    font-size: 15px;
    color: var(--primary-color);
}

/* Sets */
.set-item {
    background: var(--light-bg);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
}

.set-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.set-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    cursor: pointer;
    user-select: none;
}

.set-number {
    font-weight: 600;
    font-size: 15px;
}

.delete-set-btn {
    background: var(--danger-color);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
}

/* Compact Value Layout */
.set-values-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.value-row-compact {
    background: var(--light-bg);
    padding: 8px;
    border-radius: 6px;
}

.value-label-compact {
    font-size: 12px;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.value-group-horizontal {
    display: flex;
    gap: 12px;
    align-items: center;
}

.value-section-compact {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 4px;
}

.value-type-compact {
    font-size: 13px;
    color: #6c757d;
    font-weight: 600;
    min-width: 18px;
}

.value-controls-compact {
    display: flex;
    align-items: center;
    gap: 4px;
    flex: 1;
}

/* Mobile-Optimized Set Layout - Stacked Vertically */
.set-values {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease, margin 0.3s ease;
}

.set-values.collapsed {
    max-height: 0;
    margin-top: 0;
}

.value-row {
    background: white;
    padding: 8px;
    border-radius: 6px;
}

.value-label {
    font-size: 13px;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.value-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

.value-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.value-type {
    font-size: 11px;
    color: #6c757d;
    font-weight: 500;
}

.value-controls {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Control Buttons - Large Touch Targets */
.btn-control {
    width: var(--touch-target);
    height: var(--touch-target);
    border-radius: 8px;
    border: none;
    background: var(--primary-color);
    color: white;
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-control:active {
    background: #0a58ca;
    transform: scale(0.95);
}

/* Compact Control Buttons */
.btn-control-compact {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    border: none;
    background: var(--primary-color);
    color: white;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
}

.btn-control-compact:active {
    background: #0a58ca;
    transform: scale(0.95);
}

.value-input {
    flex: 1;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 8px;
    font-size: 16px;
    font-weight: 600;
    min-width: 60px;
}

.value-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.value-input-compact {
    flex: 1;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 6px;
    font-size: 16px;
    font-weight: 600;
    min-width: 50px;
    background: white;
}

.value-input-compact:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Add Set Button */
.add-set-btn {
    width: 100%;
    height: var(--touch-target);
    background: white;
    border: 2px dashed var(--primary-color);
    color: var(--primary-color);
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
}

/* Action Buttons */
.action-buttons {
    margin-top: 16px;
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--border-color);
    display: flex;
    padding: 8px 0;
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
}

.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px;
    border: none;
    background: none;
    color: #6c757d;
    font-size: 12px;
    cursor: pointer;
}

.nav-item i {
    font-size: 24px;
    margin-bottom: 4px;
}

.nav-item.active {
    color: var(--primary-color);
}

.nav-item:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* Workout Detail Modal */
.workout-detail-meta {
    background: var(--light-bg);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    font-size: 14px;
}

.detail-item i {
    color: var(--primary-color);
    font-size: 16px;
    width: 20px;
}

.workout-detail-exercises {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.detail-exercise-card {
    background: var(--light-bg);
    border-radius: 8px;
    padding: 12px;
}

.detail-exercise-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 2px solid #dee2e6;
}

.detail-exercise-header strong {
    font-size: 15px;
    color: #333;
}

.detail-sets {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.detail-set-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    background: white;
    border-radius: 6px;
    font-size: 13px;
}

.detail-set-number {
    font-weight: 600;
    color: #6c757d;
    min-width: 50px;
}

.detail-set-values {
    display: flex;
    gap: 12px;
    flex: 1;
    justify-content: space-around;
}

.detail-planned {
    color: #495057;
}

.detail-actual {
    color: var(--success-color);
    font-weight: 600;
}

/* Modal Optimizations */
.modal-content {
    border-radius: 16px;
}

.modal-header {
    border-bottom: 1px solid var(--border-color);
    padding: 16px;
}

.modal-body {
    padding: 20px 16px;
}

.modal-footer {
    border-top: 1px solid var(--border-color);
    padding: 16px;
}

#exerciseNameInput {
    font-size: 16px;
    padding: 12px;
    border-radius: 8px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
}

/* Buttons */
.btn-lg {
    min-height: 52px;
    font-size: 17px;
    font-weight: 600;
    border-radius: 12px;
}

/* Responsive adjustments for larger phones */
@media (min-width: 400px) {
    .workout-content {
        padding: 16px 16px 80px 16px;
    }
    
    .exercise-body {
        padding: 16px;
    }
}

/* Prevent zoom on input focus */
input[type="text"],
input[type="number"] {
    font-size: 16px;
}

/* Smooth scrolling */
html {
    scroll-behavior: smooth;
}

/* Remove spinner from number inputs */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
}
    </style>
</head>
<body>
    <!-- Home Screen -->
    <div id="homeScreen" class="screen">
        <div class="container-fluid h-100 d-flex flex-column justify-content-center align-items-center">
            <h1 class="display-4 mb-4">Gym Tracker</h1>
            <button id="startWorkoutBtn" class="btn btn-primary btn-lg mb-3">
                <i class="bi bi-play-circle"></i> Start Workout
            </button>
            <button class="btn btn-outline-light btn-lg" onclick="showHistoryScreen()">
                <i class="bi bi-clock-history"></i> View History
            </button>
        </div>
    </div>

    <!-- History Screen -->
    <div id="historyScreen" class="screen d-none">
        <!-- Sticky Header -->
        <div class="sticky-header">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-2">
                    <button class="btn-back" onclick="showHomeScreen()">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <h5 class="mb-0">Workout History</h5>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="clearAllHistory()">
                    <i class="bi bi-trash"></i> Clear All
                </button>
            </div>
        </div>

        <!-- History Content -->
        <div class="history-content" id="historyContent">
            <!-- History items will be rendered here -->
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item" onclick="showHomeScreen()">
                <i class="bi bi-house-door"></i>
                <span>Home</span>
            </button>
            <button class="nav-item active">
                <i class="bi bi-clock-history"></i>
                <span>History</span>
            </button>
        </div>
    </div>

    <!-- Active Workout Screen -->
    <div id="workoutScreen" class="screen d-none">
        <!-- Sticky Header -->
        <div class="sticky-header">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Active Workout</h5>
                <div class="timer" id="workoutTimer">00:00:00</div>
            </div>
            <button id="toggleAllBtn" class="btn btn-sm btn-outline-secondary w-100" onclick="toggleAllExercises()">
                <i class="bi bi-arrows-collapse"></i> <span id="toggleAllText">Collapse All</span>
            </button>
        </div>

        <!-- Workout Content -->
        <div class="workout-content">
            <div id="exercisesList" class="exercises-list">
                <!-- Exercises will be added here dynamically -->
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="addExerciseBtn" class="btn btn-outline-primary btn-lg w-100 mb-2">
                    <i class="bi bi-plus-circle"></i> Add Exercise
                </button>
                <button id="completeWorkoutBtn" class="btn btn-success btn-lg w-100">
                    <i class="bi bi-check-circle"></i> Complete Workout
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showHomeScreen()">
                <i class="bi bi-house-door"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" onclick="showHistoryScreen()">
                <i class="bi bi-clock-history"></i>
                <span>History</span>
            </button>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div class="modal fade" id="workoutDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="workoutDetailTitle">Workout Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="workoutDetailBody">
                    <!-- Details will be rendered here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteWorkoutBtn">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-primary" id="useTemplateBtn">
                        <i class="bi bi-file-earmark-plus"></i> Use as Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div class="modal fade" id="addExerciseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Exercise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="exerciseNameInput" class="form-control form-control-lg" placeholder="Exercise name" autocomplete="off">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveExerciseBtn" class="btn btn-primary">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
// State Management
let currentWorkout = null;
let timerInterval = null;

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
});

function initializeApp() {
    // Check if there's an active workout
    loadCurrentWorkout();
    
    // Event listeners
    document.getElementById('startWorkoutBtn').addEventListener('click', startWorkout);
    document.getElementById('addExerciseBtn').addEventListener('click', () => showAddExerciseModal());
    document.getElementById('saveExerciseBtn').addEventListener('click', saveExercise);
    document.getElementById('completeWorkoutBtn').addEventListener('click', completeWorkout);
    
    // Modal enter key support
    document.getElementById('exerciseNameInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveExercise();
    });
    
    // Show appropriate screen
    if (currentWorkout) {
        showWorkoutScreen();
    } else {
        showHomeScreen();
    }
}

// Screen Management
function showHomeScreen() {
    document.getElementById('homeScreen').classList.remove('d-none');
    document.getElementById('workoutScreen').classList.add('d-none');
    document.getElementById('historyScreen').classList.add('d-none');
}

function showWorkoutScreen() {
    document.getElementById('homeScreen').classList.add('d-none');
    document.getElementById('workoutScreen').classList.remove('d-none');
    document.getElementById('historyScreen').classList.add('d-none');
    renderExercises();
    startTimer();
}

function showHistoryScreen() {
    document.getElementById('homeScreen').classList.add('d-none');
    document.getElementById('workoutScreen').classList.add('d-none');
    document.getElementById('historyScreen').classList.remove('d-none');
    renderHistory();
}

// Workout Management
function startWorkout() {
    currentWorkout = {
        id: Date.now(),
        startTime: new Date().toISOString(),
        exercises: []
    };
    saveCurrentWorkout();
    showWorkoutScreen();
}

function completeWorkout() {
    if (!currentWorkout || currentWorkout.exercises.length === 0) {
        alert('Add at least one exercise before completing the workout!');
        return;
    }
    
    if (confirm('Complete this workout?')) {
        // Calculate metadata
        currentWorkout.endTime = new Date().toISOString();
        const startTime = new Date(currentWorkout.startTime).getTime();
        const endTime = new Date(currentWorkout.endTime).getTime();
        currentWorkout.duration = Math.floor((endTime - startTime) / 1000);
        
        let totalSets = 0;
        currentWorkout.exercises.forEach(ex => {
            totalSets += ex.sets.length;
        });
        currentWorkout.totalSets = totalSets;
        currentWorkout.totalExercises = currentWorkout.exercises.length;
        
        saveToHistory();
        currentWorkout = null;
        localStorage.removeItem('currentWorkout');
        stopTimer();
        showHomeScreen();
        alert('Workout completed and saved!');
    }
}

function saveToHistory() {
    const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    history.unshift(currentWorkout);
    if (history.length > 100) {
        history.splice(100);
    }
    localStorage.setItem('workoutHistory', JSON.stringify(history));
}

// Exercise Management
function showAddExerciseModal() {
    const modal = new bootstrap.Modal(document.getElementById('addExerciseModal'));
    document.getElementById('exerciseNameInput').value = '';
    modal.show();
    setTimeout(() => document.getElementById('exerciseNameInput').focus(), 300);
}

function saveExercise() {
    const name = document.getElementById('exerciseNameInput').value.trim();
    if (!name) {
        alert('Please enter an exercise name');
        return;
    }
    
    const exercise = {
        id: Date.now(),
        name: name,
        collapsed: false,
        selectedSetIndex: null,
        sets: []
    };
    
    currentWorkout.exercises.push(exercise);
    saveCurrentWorkout();
    renderExercises();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('addExerciseModal'));
    modal.hide();
}

function deleteExercise(exerciseId) {
    if (confirm('Delete this exercise and all its sets?')) {
        currentWorkout.exercises = currentWorkout.exercises.filter(ex => ex.id !== exerciseId);
        saveCurrentWorkout();
        renderExercises();
    }
}

// Set Management
function addSet(exerciseId) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    const previousSet = exercise.sets[exercise.sets.length - 1];
    const defaultValues = previousSet ? { ...previousSet.planned } : { weight: 0, reps: 0, time: 0 };
    
    const newSet = {
        collapsed: false,
        planned: { ...defaultValues },
        actual: { weight: 0, reps: 0, time: 0 }
    };
    
    exercise.sets.push(newSet);
    
    if (exercise.selectedSetIndex === null) {
        exercise.selectedSetIndex = 0;
    }
    
    saveCurrentWorkout();
    renderExercises();
}

function deleteSet(exerciseId, setIndex) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    if (confirm('Delete this set?')) {
        exercise.sets.splice(setIndex, 1);
        
        if (exercise.selectedSetIndex >= exercise.sets.length) {
            exercise.selectedSetIndex = exercise.sets.length - 1;
        }
        if (exercise.sets.length === 0) {
            exercise.selectedSetIndex = null;
        }
        
        saveCurrentWorkout();
        renderExercises();
    }
}

function selectSet(exerciseId, setIndex) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    exercise.selectedSetIndex = setIndex;
    saveCurrentWorkout();
    renderExercises();
}

function updateValue(exerciseId, setIndex, type, field, change) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise || !exercise.sets[setIndex]) return;
    
    const currentValue = exercise.sets[setIndex][type][field];
    let newValue = currentValue + change;
    
    if (newValue < 0) newValue = 0;
    
    exercise.sets[setIndex][type][field] = newValue;
    saveCurrentWorkout();
    
    const inputId = `${type}-${field}-${exerciseId}-${setIndex}`;
    const input = document.getElementById(inputId);
    if (input) input.value = newValue;
}

function handleDirectInput(exerciseId, setIndex, type, field, value) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise || !exercise.sets[setIndex]) return;
    
    let numValue = parseInt(value) || 0;
    if (numValue < 0) numValue = 0;
    
    exercise.sets[setIndex][type][field] = numValue;
    saveCurrentWorkout();
}

// Collapse Management
function toggleExercise(exerciseId) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    exercise.collapsed = !exercise.collapsed;
    saveCurrentWorkout();
    renderExercises();
}

function toggleSet(exerciseId, setIndex) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise || !exercise.sets[setIndex]) return;
    
    exercise.sets[setIndex].collapsed = !exercise.sets[setIndex].collapsed;
    saveCurrentWorkout();
    renderExercises();
}

function toggleAllExercises() {
    if (!currentWorkout || currentWorkout.exercises.length === 0) return;
    
    const anyExpanded = currentWorkout.exercises.some(ex => !ex.collapsed);
    const newState = anyExpanded;
    
    currentWorkout.exercises.forEach(exercise => {
        exercise.collapsed = newState;
    });
    
    saveCurrentWorkout();
    renderExercises();
    
    const btnText = document.getElementById('toggleAllText');
    const btnIcon = document.querySelector('#toggleAllBtn i');
    if (newState) {
        btnText.textContent = 'Expand All';
        btnIcon.className = 'bi bi-arrows-expand';
    } else {
        btnText.textContent = 'Collapse All';
        btnIcon.className = 'bi bi-arrows-collapse';
    }
}

// Rendering
function renderExercises() {
    const container = document.getElementById('exercisesList');
    
    if (!currentWorkout || currentWorkout.exercises.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-clipboard-x"></i>
                <p>No exercises yet.<br>Tap "Add Exercise" to begin!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = currentWorkout.exercises.map(exercise => `
        <div class="exercise-card">
            <div class="exercise-header" onclick="event.target.closest('.exercise-header').querySelector('.delete-exercise-btn').contains(event.target) ? null : toggleExercise(${exercise.id})">
                <div class="exercise-header-left">
                    <i class="bi bi-chevron-down chevron ${exercise.collapsed ? 'collapsed' : ''}"></i>
                    <h6>${exercise.name}</h6>
                </div>
                <button class="delete-exercise-btn" onclick="event.stopPropagation(); deleteExercise(${exercise.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="exercise-body ${exercise.collapsed ? 'collapsed' : ''}">
                ${renderSet(exercise.id, exercise)}
                <button class="add-set-btn" onclick="addSet(${exercise.id})">
                    <i class="bi bi-plus-lg"></i> Add Set
                </button>
            </div>
        </div>
    `).join('');
}

function renderSet(exerciseId, exercise) {
    if (!exercise.sets || exercise.sets.length === 0) {
        return '';
    }
    
    const selectedIndex = exercise.selectedSetIndex ?? 0;
    const selectedSet = exercise.sets[selectedIndex];
    
    return `
        <div class="sets-overview-container">
            <div class="sets-overview">
                ${exercise.sets.map((set, index) => `
                    <div class="set-card ${index === selectedIndex ? 'selected' : ''}" 
                         onclick="selectSet(${exerciseId}, ${index})">
                        <div class="set-card-number">Set ${index + 1}</div>
                        <div class="set-card-value">${set.planned.weight || 0} × ${set.planned.reps || 0}</div>
                        ${set.actual.weight > 0 || set.actual.reps > 0 ? 
                            `<div class="set-card-actual">✓ ${set.actual.weight} × ${set.actual.reps}</div>` : 
                            '<div class="set-card-pending">—</div>'
                        }
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="current-set-details">
            <div class="current-set-header">
                <span class="current-set-title">Set ${selectedIndex + 1} Details</span>
                <button class="delete-set-btn" onclick="deleteSet(${exerciseId}, ${selectedIndex})">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="set-values-compact">
                ${renderCompactValueRow(exerciseId, selectedIndex, 'weight', 'Weight (lbs)', selectedSet, 5)}
                ${renderCompactValueRow(exerciseId, selectedIndex, 'reps', 'Reps', selectedSet, 1)}
                ${renderCompactValueRow(exerciseId, selectedIndex, 'time', 'Time (sec)', selectedSet, 5)}
            </div>
        </div>
    `;
}

function renderCompactValueRow(exerciseId, setIndex, field, label, set, increment) {
    return `
        <div class="value-row-compact">
            <div class="value-label-compact">${label}</div>
            <div class="value-group-horizontal">
                <div class="value-section-compact">
                    <span class="value-type-compact">P:</span>
                    <div class="value-controls-compact">
                        <button class="btn-control-compact" onclick="updateValue(${exerciseId}, ${setIndex}, 'planned', '${field}', -${increment})">−</button>
                        <input type="number" 
                               id="planned-${field}-${exerciseId}-${setIndex}"
                               class="value-input-compact" 
                               value="${set.planned[field]}"
                               onchange="handleDirectInput(${exerciseId}, ${setIndex}, 'planned', '${field}', this.value)"
                               inputmode="numeric">
                        <button class="btn-control-compact" onclick="updateValue(${exerciseId}, ${setIndex}, 'planned', '${field}', ${increment})">+</button>
                    </div>
                </div>
                <div class="value-section-compact">
                    <span class="value-type-compact">A:</span>
                    <div class="value-controls-compact">
                        <button class="btn-control-compact" onclick="updateValue(${exerciseId}, ${setIndex}, 'actual', '${field}', -${increment})">−</button>
                        <input type="number" 
                               id="actual-${field}-${exerciseId}-${setIndex}"
                               class="value-input-compact" 
                               value="${set.actual[field]}"
                               onchange="handleDirectInput(${exerciseId}, ${setIndex}, 'actual', '${field}', this.value)"
                               inputmode="numeric">
                        <button class="btn-control-compact" onclick="updateValue(${exerciseId}, ${setIndex}, 'actual', '${field}', ${increment})">+</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Timer
function startTimer() {
    if (timerInterval) return;
    
    const startTime = new Date(currentWorkout.startTime).getTime();
    
    timerInterval = setInterval(() => {
        const now = Date.now();
        const elapsed = now - startTime;
        
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        const display = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        document.getElementById('workoutTimer').textContent = display;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function pad(num) {
    return num.toString().padStart(2, '0');
}

// LocalStorage
function saveCurrentWorkout() {
    localStorage.setItem('currentWorkout', JSON.stringify(currentWorkout));
}

function loadCurrentWorkout() {
    const saved = localStorage.getItem('currentWorkout');
    if (saved) {
        currentWorkout = JSON.parse(saved);
    }
}

// History Management
function renderHistory() {
    const container = document.getElementById('historyContent');
    const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    
    if (history.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-clock-history"></i>
                <p>No Workouts Yet</p>
                <p class="text-muted">Complete your first workout<br>to see it here!</p>
                <button class="btn btn-primary mt-3" onclick="showHomeScreen()">
                    <i class="bi bi-play-circle"></i> Start Workout
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = history.map((workout, index) => {
        const date = new Date(workout.startTime);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const durationStr = formatDuration(workout.duration || 0);
        const exerciseNames = workout.exercises.map(ex => ex.name).join(', ');
        const exercisePreview = exerciseNames.length > 40 ? exerciseNames.substring(0, 37) + '...' : exerciseNames;
        
        return `
            <div class="history-card" onclick="viewWorkoutDetail(${workout.id})">
                <div class="history-card-header">
                    <div class="history-date">${dateStr}</div>
                    <div class="history-duration">
                        <i class="bi bi-stopwatch"></i> ${durationStr}
                    </div>
                </div>
                <div class="history-stats">
                    ${workout.totalExercises || workout.exercises.length} exercises • ${workout.totalSets || 0} sets
                </div>
                <div class="history-exercises">${exercisePreview}</div>
                <div class="history-time">${timeStr}</div>
            </div>
        `;
    }).join('');
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${pad(minutes)}:${pad(secs)}`;
    }
    return `${minutes}:${pad(secs)}`;
}

function viewWorkoutDetail(workoutId) {
    const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    const workout = history.find(w => w.id === workoutId);
    
    if (!workout) return;
    
    const modal = new bootstrap.Modal(document.getElementById('workoutDetailModal'));
    const date = new Date(workout.startTime);
    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    
    document.getElementById('workoutDetailTitle').textContent = dateStr;
    
    const startTime = new Date(workout.startTime);
    const endTime = workout.endTime ? new Date(workout.endTime) : null;
    const durationStr = formatDuration(workout.duration || 0);
    
    const detailsHtml = `
        <div class="workout-detail-meta">
            <div class="detail-item">
                <i class="bi bi-stopwatch"></i>
                <strong>Duration:</strong> ${durationStr}
            </div>
            <div class="detail-item">
                <i class="bi bi-clock"></i>
                <strong>Started:</strong> ${startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
            </div>
            ${endTime ? `
                <div class="detail-item">
                    <i class="bi bi-check-circle"></i>
                    <strong>Completed:</strong> ${endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                </div>
            ` : ''}
        </div>
        
        <div class="workout-detail-exercises">
            ${workout.exercises.map(exercise => `
                <div class="detail-exercise-card">
                    <div class="detail-exercise-header">
                        <strong>${exercise.name}</strong>
                        <span class="badge bg-primary">${exercise.sets.length} sets</span>
                    </div>
                    <div class="detail-sets">
                        ${exercise.sets.map((set, index) => `
                            <div class="detail-set-row">
                                <span class="detail-set-number">Set ${index + 1}</span>
                                <div class="detail-set-values">
                                    <span class="detail-planned">P: ${set.planned.weight}lbs × ${set.planned.reps}${set.planned.time > 0 ? ` (${set.planned.time}s)` : ''}</span>
                                    <span class="detail-actual">A: ${set.actual.weight}lbs × ${set.actual.reps}${set.actual.time > 0 ? ` (${set.actual.time}s)` : ''}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('workoutDetailBody').innerHTML = detailsHtml;
    
    document.getElementById('deleteWorkoutBtn').onclick = () => {
        deleteWorkout(workoutId);
        modal.hide();
    };
    
    document.getElementById('useTemplateBtn').onclick = () => {
        useAsTemplate(workoutId);
        modal.hide();
    };
    
    modal.show();
}

function deleteWorkout(workoutId) {
    if (!confirm('Delete this workout from history?')) return;
    
    let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    history = history.filter(w => w.id !== workoutId);
    localStorage.setItem('workoutHistory', JSON.stringify(history));
    renderHistory();
}

function clearAllHistory() {
    if (!confirm('Delete ALL workout history? This cannot be undone!')) return;
    
    localStorage.removeItem('workoutHistory');
    renderHistory();
}

function useAsTemplate(workoutId) {
    const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    const workout = history.find(w => w.id === workoutId);
    
    if (!workout) return;
    
    currentWorkout = {
        id: Date.now(),
        startTime: new Date().toISOString(),
        exercises: workout.exercises.map(exercise => ({
            id: Date.now() + Math.random(),
            name: exercise.name,
            collapsed: false,
            selectedSetIndex: 0,
            sets: exercise.sets.map(set => ({
                collapsed: false,
                planned: { ...set.actual },
                actual: { weight: 0, reps: 0, time: 0 }
            }))
        }))
    };
    
    saveCurrentWorkout();
    showWorkoutScreen();
    alert('Template loaded! Adjust values as needed.');
}
    </script>
</body>
</html>
